import scrapy
from bs4 import BeautifulSoup
from ..items import URLHarvesterItem
from tqdm import tqdm

class URLHarvesterSpider(scrapy.Spider):
    name = 'url_harvester'
    start_urls = []

    def __init__(self):
        # brand_list = ['Abarth', 'Aiways', 'Aleko', 'Alfa Romeo', 'Alpina', 'Aro', 'Aston Martin', 'Audi', 'Austin', 'Autres', 'Auverland', 'BMW', 'Bentley', 'Bertone', 'Buggy', 'Buick', 'Cadillac', 'Caterham', 'Chevrolet', 'Chrysler', 'CitroÃ«n', 'Corvette', 'Cupra', 'DS', 'Dacia', 'Daewoo', 'Daihatsu', 'Daimler', 'Dangel', 'De la Chapelle', 'Dodge', 'Donkervoort', 'Ferrari', 'Fiat', 'Ford', 'GMC', 'Gac Gonow', 'Honda', 'Hummer', 'Hyundai', 'Infiniti', 'Isuzu', 'Jaguar', 'Jeep', 'Kia', 'Lada', 'Lamborghini', 'Lancia', 'Land-Rover', 'Landwin', 'Lexus', 'Lotus', 'MG', 'MPM Motos', 'Mahindra', 'Maruti', 'Maserati', 'Maybach', 'Mazda', 'Mega', 'Mercedes', 'Mini', 'Mitsubishi', 'Morgan', 'Nissan', 'Opel', 'PGO', 'Peugeot', 'Polski/FSO', 'Pontiac', 'Porsche', 'Proton', 'Renault', 'Rolls-Royce', 'Rover', 'Saab', 'Santana', 'Seat', 'Seres', 'Shuanghuan', 'Skoda', 'Smart', 'Ssangyong', 'Subaru', 'Suzuki', 'TVR', 'Talbot', 'Tata', 'Tesla', 'Toyota', 'Venturi', 'Volkswagen', 'Volvo', 'Wallys']
        brand_list = ['dacia/duster','mini/cooper','nissan/qashqai','citroen/ds3','fiat/500','volkswagen/golf','citroen/ds7','opel/corsa','seat/leon','dacia/sandero','mercedes/classe-a','toyota/yaris','peugeot/208','toyota/c-hr','bmw/serie-1','seat/ibiza','ford/fiesta','audi/a3','peugeot/3008','ford/kuga','nissan/juke','fiat/500-x','mini/countryman','mercedes/classe-c','ford/focus','peugeot/308','bmw/serie-3','volvo/xc60','toyota/aygo','peugeot/2008','opel/mokka','nissan/micra','land-rover/range-rover-evoque','renault/captur','volkswagen/tiguan','opel/astra','porsche/911','hyundai/tucson','kia/sportage','renault/clio','volkswagen/polo','seat/arona','audi/a1','toyota/corolla','bmw/x1','audi/a4','seat/ateca','fiat/tipo','audi/q3','opel/crossland-x','mercedes/classe-cla','mini/cooper-d','toyota/rav-4','mazda/mx-5','renault/kadjar','porsche/macan','kia/ceed','opel/grandland-x','mercedes/classe-gla','mercedes/classe-glc','bmw/serie-2','nissan/x-trail','lexus/ux','suzuki/vitara','opel/insignia','jeep/renegade','ford/mustang','porsche/cayenne','hyundai/i30','mini/mini-coupe','audi/a5','audi/q5','suzuki/swift','toyota/auris','citroen/ds5','volkswagen/t-roc','citroen/ds4','fiat/panda','bmw/x3','renault/clio-iv','mercedes/classe-e','ford/ecosport','ford/puma','audi/q2','bmw/serie-5','renault/megane','mercedes/classe-b','porsche/boxster','dacia/logan','abarth/500','jeep/compass','mini/clubman','bmw/serie-4','dacia/lodgy','skoda/fabia','hyundai/i20','bmw/x2','volvo/v40','mazda/cx-3','peugeot/5008','hyundai/kona','honda/cr-v','volvo/xc40','skoda/octavia','jaguar/f-pace','smart/fortwo','renault/clio-v','renault/twingo','kia/niro','kia/picanto','jaguar/xf','land-rover/range-rover','renault/megane-iv','jeep/wrangler','skoda/yeti','hyundai/i10','audi/a6','opel/adam','porsche/panamera','volkswagen/t-cross','skoda/kamiq','volkswagen/passat','land-rover/discovery-sport','peugeot/308-sw','audi/tt','peugeot/108','skoda/superb','honda/civic','volkswagen/touran','toyota/divers','kia/pro-cee-d-ii','porsche/cayman','bmw/x5','skoda/karoq','peugeot/508','volvo/v60','bmw/x4','dodge/ram','jaguar/xe','kia/rio','suzuki/sx4','mazda/cx-5','land-rover/discovery','renault/scenic','mazda/cx-30','renault/twingo-iii','hyundai/ioniq','jaguar/e-pace','fiat/punto','dacia/dokker','kia/stonic','mazda/mazda3','skoda/kodiaq','suzuki/ignis','mercedes/classe-v','volkswagen/multivan','ford/ranger','kia/xceed','renault/talisman','renault/zoe','lexus/nx','ford/ka','smart/forfour','volvo/xc90','ford/focus-c-max','bmw/x6','peugeot/207','renault/scenic-iv','cupra/formentor','nissan/leaf','ford/b-max','lexus/ct','renault/kangoo','mazda/mazda2','opel/meriva','volkswagen/coccinelle-ii','toyota/avensis','renault/grand-scenic-iv','fiat/500-l','ford/c-max','ford/mondeo','audi/s3','ford/transit','porsche/911-carrera-32','opel/zafira','ford/s-max','mercedes/classe-gle','lexus/is','mitsubishi/outlander','toyota/land-cruiser','bmw/z4','abarth/595','infiniti/q30','toyota/verso','volkswagen/beetle','volkswagen/scirocco','audi/r8','mitsubishi/space-star','volkswagen/up','opel/divers','renault/koleos','mini/one','ford/divers','jeep/grand-cherokee','tesla/model-s','maserati/ghibli','lexus/rx','opel/combo-vp','mercedes/classe-cls','mini/cooper-s','seat/divers','suzuki/jimny','honda/hr-v','audi/a7','nissan/qashqai-2','toyota/prius','maserati/levante','renault/espace','nissan/navara','mercedes/classe-m','renault/grand-scenic-iii','mitsubishi/l200','nissan/pulsar','peugeot/508-sw','peugeot/206','volkswagen/divers','audi/sq5','maserati/quattroporte','bmw/serie-6','land-rover/range-sport','maserati/granturismo','fiat/doblo','mazda/mx-30','volkswagen/touareg','land-rover/range-rover-velar','nissan/note','bmw/i3','land-rover/freelander','jaguar/f-type','audi/q7','renault/clio-iii','tesla/model-3','mitsubishi/asx','opel/crossland','volkswagen/jetta','renault/twingo-ii','renault/arkana','hyundai/santa-fe','mercedes/slk','toyota/hilux','mini/paceman','audi/rs3','mercedes/classe-s','ford/edge','ford/galaxy','mercedes/divers','chevrolet/corvette','skoda/scala','jeep/divers','hyundai/ix35','fiat/500-c','bmw/serie-7','renault/scenic-iii','renault/megane-iii','bentley/continental-gt','mitsubishi/pajero','opel/karl','volkswagen/arteon','volvo/c70','infiniti/q50','fiat/124-spider','peugeot/partner','honda/jazz','volkswagen/golf-sw','volkswagen/caddy','land-rover/divers','mercedes/viano','skoda/citigo','renault/trafic','lexus/rc','bmw/m2','audi/s5','fiat/fiat-600','volkswagen/tiguan-allspace','kia/sorento','jeep/cherokee','volkswagen/eos','land-rover/defender','audi/e-tron','opel/antara','renault/grand-scenic-ii','isuzu/d-max','bmw/m4','renault/megane-iv-estate','mazda/mazda6','cupra/leon','fiat/divers','mercedes/clk','kia/optima','audi/rs6','hyundai/veloster','subaru/forester','mazda/cx-7','fiat/grande-punto','audi/a8','nissan/divers','kia/venga','audi/rs4','kia/ceed-sw','audi/q8','porsche/911-997-','peugeot/partner-tepee','volkswagen/sharan','ssangyong/rodius','chevrolet/captiva','ferrari/california','renault/clio-ii','porsche/911-996-','suzuki/s-cross','bmw/m3','mercedes/sl','subaru/xv','seat/alhambra','mercedes/classe-glk','volvo/s60','ferrari/308','porsche/911-991-','chevrolet/camaro','audi/rs-q3','mercedes/eqv','peugeot/107','kia/soul','mercedes/glb','ford/fusion','ford/grand-c-max','volkswagen/amarok','chevrolet/spark','bentley/continental','ferrari/458','seat/altea','kia/carens','opel/agila','renault/clio-iv-estate','ferrari/f430','skoda/rapid','lancia/ypsilon','porsche/divers','volvo/s90','chevrolet/aveo','volkswagen/caravelle','volvo/v90','seat/tarraco','mini/one-d','mercedes/classe-g','hyundai/bayon','peugeot/rcz','peugeot/traveller','dodge/charger','mercedes/amg-gt','saab/9-3','chrysler/300c','bmw/divers','nissan/370-z','bmw/serie-8','toyota/iq','jaguar/xk','audi/s4','renault/modus','ferrari/488','mercedes/classe-r','jaguar/i-pace','cadillac/escalade','audi/rs5','audi/allroad','hyundai/ix20','mitsubishi/colt','lamborghini/gallardo','chrysler/pt-cruiser','jaguar/xj','mini/divers','volkswagen/id3','jaguar/s-type','suzuki/grand-vitara','volvo/xc70','porsche/taycan','peugeot/307-cc','peugeot/307','renault/laguna','toyota/proace-city','dodge/divers','lamborghini/huracan','mercedes/classe-cl','volvo/v70','renault/scenic-ii','peugeot/407','volkswagen/id4','mercedes/slc','ssangyong/tivoli','suzuki/alto','opel/vectra','nissan/pixo','audi/divers','volvo/c30','suzuki/baleno','dacia/divers','dacia/jogger','mercedes/eqc','chevrolet/divers','opel/grandland','renault/divers','fiat/bravo','ford/tourneo-vp','maserati/grancabrio','suzuki/divers','ferrari/599','renault/megane-ii','chevrolet/cruze','toyota/yaris-cross','mini/mini-roadster','audi/s6','subaru/impreza','mitsubishi/eclipse-cross','bmw/m5','hyundai/i40','abarth/abarth-124-spider','seat/altea-xl','audi/tt-s','mercedes/classe-gl','nissan/terrano','porsche/944','lamborghini/divers','chevrolet/matiz','peugeot/306','mazda/mx-3','dodge/challenger','chevrolet/trax','volkswagen/taigo','lotus/evora','infiniti/fx','suzuki/swace','peugeot/1007','suzuki/celerio','renault/laguna-iii','volvo/v50','ssangyong/korando','volkswagen/golf-plus','bmw/ix','ssangyong/rexton','mercedes/citan','peugeot/rifter','toyota/corolla-verso','peugeot/207-cc','suzuki/splash','mercedes/300','volkswagen/fox','bmw/z3','mercedes/classe-gls','renault/super-5','volkswagen/e-golf','jaguar/x-type','honda/accord','toyota/gt86','peugeot/807','jaguar/xk8','mazda/mazda5','audi/sq7','nissan/murano','lexus/es','ferrari/612','nissan/primera','fiat/freemont','peugeot/607','ferrari/ff','jaguar/xkr','chrysler/sebring','renault/megane-coupe','gmc/sierra','peugeot/207-sw','renault/megane-iii-estate','hyundai/getz','fiat/fiorino','peugeot/406-coupe','rover/mini','lancia/voyager','bmw/i8','renault/laguna-ii','renault/grand-modus','lamborghini/aventador','nissan/pathfinder','ferrari/f360','hyundai/divers','honda/honda-e','mercedes/190','peugeot/4008','peugeot/308-cc','kia/ev6','voiture-ancienne/ford','voiture-ancienne/jaguar','seat/exeo','fiat/barchetta','peugeot/206-cc','voiture-ancienne/fiat','cupra/ateca','opel/cascada','hyundai/matrix','chevrolet/orlando','peugeot/expert-tepee','chrysler/crossfire','nissan/350-z','porsche/928','renault/megane-iii-coupe','mg/mgtf','peugeot/bipper-tepee','fiat/qubo','honda/divers','voiture-ancienne/mg','suzuki/across','jaguar/xj-6','infiniti/qx30','renault/megane-ii-cc','renault/clio-iii-estate','opel/tigra','nissan/gt-r','skoda/roomster','audi/q4','renault/twizy','peugeot/205','ford/explorer','mercedes/200','lexus/lc','seat/mii','mercedes/eqa','austin/mini','lamborghini/urus','toyota/celica','chrysler/grand-voyager','toyota/previa','hummer/h2','rolls-royce/phantom','lancia/delta','maserati/coupe','lotus/elise','maserati/3200','peugeot/ion','fiat/ulysse','saab/9-5','dodge/journey','volvo/s40','mercedes/250','peugeot/406','fiat/stilo','peugeot/407-coupe','mercedes/classe-clc','skoda/enyaq','peugeot/407-sw','nissan/almera-tino','toyota/mr','audi/100','bmw/m6','porsche/boxster-987-','auverland/divers','fiat/coupe','ferrari/812','kia/stinger','ford/escort','kia/carnival','renault/megane-cabriolet','fiat/multipla','peugeot/106','mg/mgf','jaguar/xjs','rover/75','mercedes/eqs','peugeot/307-sw','subaru/outback','dodge/caliber','renault/r4','lexus/gs','tesla/model-x','seat/toledo','peugeot/405','renault/avantime','bentley/bentayga','jaguar/xj-8','fiat/sedici','mercedes/eqb','pontiac/firebird','volvo/s80','ford/maverick','toyota/camry','seat/cordoba','ferrari/575-maranello','lotus/exige','lancia/musa','dodge/nitro','ferrari/456','hyundai/coupe','hyundai/galloper','abarth/695','daihatsu/terios','mitsubishi/lancer','renault/laguna-iii-coupe','jaguar/daimler','porsche/boxster-986-','fiat/500-e','smart/roadster','ferrari/bb-512','voiture-ancienne/toyota','renault/laguna-iii-estate','voiture-ancienne/porsche','renault/scenic-xmod','voiture-ancienne/mercedes','mercedes/280','renault/vel-satis','peugeot/divers','opel/gt','ford/cougar','hyundai/sonata','renault/r5','audi/80','bmw/ix3','bmw/i4','porsche/356','renault/safrane','nissan/patrol','nissan/200','audi/a2','peugeot/206-sw','porsche/968','mercedes/560','bmw/x7','opel/ascona','nissan/almera','suzuki/samurai','mitsubishi/divers','daewoo/matiz','daihatsu/cuore','renault/grand-espace','ferrari/348','gmc/yukon','lancia/thema','lexus/ls','mg/mgehs','ssangyong/actyon','ferrari/testarossa','jaguar/divers','jaguar/sovereign','abarth/grande-punto','pontiac/divers','subaru/legacy','ferrari/f-550-maranello','infiniti/ex37','infiniti/q70','lamborghini/murcielago','renault/express','nissan/evalia','maserati/spyder','fiat/croma','infiniti/autres','ssangyong/kyron','renault/r19','cadillac/srx','honda/legend','opel/frontera','cadillac/cts','ferrari/portofino','toyota/land-cruiser-sw','bentley/arnage','chrysler/voyager','opel/speedster','morgan/divers','voiture-ancienne/pontiac','opel/ampera','ford/streetka','ferrari/412','voiture-ancienne/buick','fiat/cinquecento','bmw/z8','audi/s8','voiture-ancienne/mazda','bentley/flying-spur','voiture-ancienne/austin','rolls-royce/corniche','kia/divers','mercedes/slr','renault/megane-ii-coupe','saab/900','voiture-ancienne/maserati','peugeot/4007','morgan/plus-4','audi/v8','porsche/924','dodge/viper','corvette/divers','voiture-ancienne/volvo','fiat/palio','seat/arosa','porsche/911-993-','nissan/cube','daihatsu/materia','cadillac/eldorado','cadillac/seville','honda/cr-z','mercedes/500','volkswagen/bora','ferrari/mondial','hyundai/elantra','audi/sq8','hummer/h3','lada/niva','renault/wind','corvette/corvette-c8','dacia/spring','mitsubishi/i-miev','voiture-ancienne/renault','mazda/323','voiture-ancienne/chevrolet','subaru/brz','lexus/sc','renault/latitude','mercedes/classe-x','mazda/premacy','subaru/wrx','voiture-ancienne/dodge','nissan/pick-up','smart/roadster-coupe','renault/megane-ii-estate','hyundai/atos','voiture-ancienne/talbot','jeep/commander','santana/vitara','honda/prelude','renault/r25','suzuki/wagon-r','renault/r21','honda/crx','voiture-ancienne/rollsroyce','cadillac/allante','volvo/480','fiat/croma-sw','volkswagen/corrado','jaguar/xj-12','volvo/440','ford/sierra','chevrolet/rezzo','caterham/super-seven','corvette/z6','daewoo/kalos','volvo/s70','hyundai/satellite','kia/magentis','daewoo/lanos','volvo/940','ford/probe','porsche/carrera-gt','peugeot/604','corvette/c6','peugeot/505','infiniti/g37','mercedes/230','ferrari/328','toyota/mirai','mercedes/126','ford/scorpio','porsche/912','bentley/turbo-r','toyota/avensis-verso','volkswagen/vento','nissan/prairie','voiture-ancienne/abarth','ferrari/f8-spider','austin/autres','mercedes/vaneo','voiture-ancienne/bmw','lexus/divers','alpina/b4','mercedes/sls','alpina/divers','voiture-ancienne/volkswagen','tesla/model-y','porsche/911-964-','buggy/lm1','fiat/marea','mitsubishi/3000-gt','honda/nsx','daihatsu/sirion','toyota/supra','toyota/lite-ace','buick/divers','hyundai/terracan','bmw/z1','porsche/914','toyota/urban-cruiser','volkswagen/phaeton','buick/park-avenue','bertone/free-climber','volvo/c40','daimler/autres','subaru/trezia','opel/omega','renault/r9','renault/r30','jeep/patriot','saab/divers','hyundai/accent','ferrari/sf90','voiture-ancienne/lancia','chrysler/300m','maserati/grandsport','mg/divers','chrysler/stratus','volvo/divers','tvr/divers','jaguar/xjr','rover/serie-200','mg/mgzr','mg/mgzt','lotus/esprit','voiture-ancienne/lamborghini','saab/9000','jeep/willys','rolls-royce/ghost','rover/serie-600','rover/45','rover/divers','peugeot/605','peugeot/309','peugeot/305','rolls-royce/divers','rolls-royce/silver-dawn','chrysler/viper','renault/r11','mazda/626','mazda/rx-8','voiture-ancienne/jeep','mazda/divers','ford/granada','ford/gt','nissan/primastar','volvo/850','dodge/avenger','toyota/hiace','chevrolet/volt','daihatsu/copen','bentley/divers','opel/kadett','honda/insight','infiniti/g37-coupe','skoda/divers','mazda/rx-7','mazda/929','voiture-ancienne/cadillac','cadillac/ats','voiture-ancienne/lotus','mg/zs-ev','chevrolet/kalos','voiture-ancienne/chrysler','lancia/thesis','isuzu/trooper','suzuki/santana','hummer/h1','peugeot/806','renault/alpine']
        for brand in brand_list:
            self.start_urls.append(f"https://www.paruvendu.fr/a/voiture-occasion/{brand.lower()}/")
            
    def parse(self, response):
        url_harvester_item = URLHarvesterItem()
        if response.status != 200:
            url_harvester_item['url'] = response.request.url
            url_harvester_item['status'] = response.status
            url_harvester_item['brand'] = "N/A"

            yield url_harvester_item

        if response.status == 200:
            html_page = response.text
            soup = BeautifulSoup(html_page, 'lxml')
            listings = soup.find_all('div',{'class':'lazyload_bloc ergov3-annonce ergov3-annonceauto'})
            for listing in listings:
                url = listing.find('a').get('href')
                
                url_harvester_item['url'] = url

                yield url_harvester_item

            next_page_partial = soup.find('div',{'class':'v2pv15-pagsuiv flol'})
            if next_page_partial is not None:
                next_page = next_page_partial.find('a').get('href')
                current_page_url = response.request.url
                current_page_url_split = current_page_url.split('?')
                next_page_url = current_page_url_split[0] + next_page
                yield scrapy.Request(next_page_url, callback=self.parse)
            else:
                print(f"Job's done for {response.request.url}")

    class CarHarvesterSpider(scrapy.Spider):
        pass